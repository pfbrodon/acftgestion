{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-cash-stack text-primary me-2"></i>
      {{ title }}
    </h1>
    <a href="{% url 'caja:movimiento_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Volver a la Lista
    </a>
  </div>

  <!-- Formulario -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-plus-circle text-primary me-2"></i>
            Datos del Movimiento
          </h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            
            <div class="row g-3">
              <!-- Fecha -->
              <div class="col-md-6">
                <label for="{{ form.fecha.id_for_label }}" class="form-label">
                  <i class="bi bi-calendar-event me-1"></i>
                  Fecha
                </label>
                {{ form.fecha }}
                {% if form.fecha.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.fecha.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Tipo -->
              <div class="col-md-6">
                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                  <i class="bi bi-arrow-up-down me-1"></i>
                  Tipo de Movimiento
                </label>
                {{ form.tipo }}
                {% if form.tipo.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.tipo.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Categoría -->
              <div class="col-12">
                <label for="{{ form.categoria.id_for_label }}" class="form-label">
                  <i class="bi bi-tags me-1"></i>
                  Categoría
                </label>
                {{ form.categoria }}
                {% if form.categoria.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.categoria.errors.0 }}
                  </div>
                {% endif %}
                <div class="form-text">
                  La categoría debe corresponder al tipo de movimiento seleccionado.
                </div>
              </div>

              <!-- Monto -->
              <div class="col-md-6">
                <label for="{{ form.monto.id_for_label }}" class="form-label">
                  <i class="bi bi-currency-dollar me-1"></i>
                  Monto
                </label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  {{ form.monto }}
                </div>
                {% if form.monto.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.monto.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Descripción -->
              <div class="col-12">
                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                  <i class="bi bi-text-paragraph me-1"></i>
                  Descripción
                </label>
                {{ form.descripcion }}
                {% if form.descripcion.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.descripcion.errors.0 }}
                  </div>
                {% endif %}
                <div class="form-text">
                  Proporcione una descripción detallada del movimiento.
                </div>
              </div>
            </div>

            <!-- Botones -->
            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>
                Guardar Movimiento
              </button>
              <a href="{% url 'caja:movimiento_list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle me-1"></i>
                Cancelar
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Agregar clases de Bootstrap a los campos del formulario
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        field.classList.add('form-control');
    });

    // Filtrar categorías por tipo
    const tipoField = document.getElementById('{{ form.tipo.id_for_label }}');
    const categoriaField = document.getElementById('{{ form.categoria.id_for_label }}');
    
    if (tipoField && categoriaField) {
        const todasLasCategorias = Array.from(categoriaField.options);
        
        function filtrarCategorias() {
            const tipoSeleccionado = tipoField.value;
            
            // Limpiar opciones
            categoriaField.innerHTML = '<option value="">---------</option>';
            
            // Filtrar y agregar opciones apropiadas
            todasLasCategorias.forEach(option => {
                if (option.value) {
                    const optionText = option.text;
                    // Verificar si la categoría corresponde al tipo
                    // (esto podría mejorarse con data attributes)
                    categoriaField.appendChild(option.cloneNode(true));
                }
            });
        }
        
        tipoField.addEventListener('change', filtrarCategorias);
    }

    // Establecer fecha actual por defecto
    const fechaField = document.getElementById('{{ form.fecha.id_for_label }}');
    if (fechaField && !fechaField.value) {
        const hoy = new Date();
        const fechaFormateada = hoy.toISOString().split('T')[0];
        fechaField.value = fechaFormateada;
    }
});
</script>
{% endblock %}
